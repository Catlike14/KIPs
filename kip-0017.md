---
KIP: 0017
Title: wallet-connect-v2-sign implementation spec
Author: Jacquin Mininger @jmininger, Doug Beardsley @mightybyte
Status: Draft
Type: Standard
Category: Interface
Created: 2022-11-15
---

- [Abstract](#abstract)
- [Motivation](#motivation)
- [Specification](#specification)
  - [Namespace](#namespace)
  - [Chain ID](#chain-id)
  - [Accounts](#accounts)
    - [**Accounts vs Public Keys**](#accounts-vs-public-keys)
  - [Default Methods](#default-methods)
  - [Events](#events)
  - [SLIP-0044](#slip-0044)
- [Backwards Compatibility](#backwards-compatibility)
- [WalletConnect specification](#walletconnect-specification)
  - [Pairing with WalletConnect](#pairing-with-walletconnect)
    - [Example Pairing Proposal and Response](#example-pairing-proposal-and-response)
    - [Accounts](#accounts-1)
    - [WalletConnectAccountString](#walletconnectaccountstring)
      - [WalletConnectChainID](#walletconnectchainid)
      - [WalletConnectNamespace](#walletconnectnamespace)
      - [WalletConnectReference](#walletconnectreference)
      - [WalletConnectAccountAddress](#walletconnectaccountaddress)
  - [WalletConnect Methods](#walletconnect-methods)
    - [kadena\_get\_accounts\_v1](#kadena_get_accounts_v1)
      - [Example kadena\_get\_accounts\_v1 Request and Response](#example-kadena_get_accounts_v1-request-and-response)
      - [Request Body](#request-body)
      - [Response Body](#response-body)
        - [KadenaSigner](#kadenasigner)
        - [KadenaAccount](#kadenaaccount)
    - [kadena\_quicksign\_v1](#kadena_quicksign_v1)
      - [Example kadena\_quicksign\_v1 Request and Response](#example-kadena_quicksign_v1-request-and-response)
    - [kadena\_sign\_v1](#kadena_sign_v1)
      - [Example kadena\_sign\_v1 Request and Response](#example-kadena_sign_v1-request-and-response)
- [Rationale for the spec](#rationale-for-the-spec)

# Abstract

We propose that the Kadena ecosystem use the
[wallet-connect-v2 sign-api](https://docs.walletconnect.com/2.0/introduction/sign)
to establish a secure channel for communication between dapps and wallets that
is platform-agnostic.

# Motivation

- The prior signing-api requires the wallet to be able to run a http server.
  This is often times not possible for browser-based and mobile wallets
- The protocol is a tried and tested way of abstracting the communication
  between dapps and wallets across all devices, and removes the burden of having
  to maintain a kadena-specific implementation
- Wallet connect will allow multi-protocol wallets/dapps that are already using
  the protocol to seamlessly integrate with the kadena ecosystem

# Specification

## Namespace

- Namespaces are a way of identifying blockchain ecosystems in the
  wallet-connect protocol.
- In WC namespaces must abide by the
  [CAIP-2 standard](https://github.com/ChainAgnostic/CAIPs/blob/master/CAIPs/caip-2.md)
  which imposes the following pattern-based restriction: `[-a-z0-9]{3,8}`
- The namespace for kadena is `kadena`

## Chain ID

- Chain IDs are wallet-connect’s way of identifying specific blockchains within
  an ecosystem. They are defined by the
  [CAIP-2 standard](https://github.com/ChainAgnostic/CAIPs/blob/master/CAIPs/caip-2.md),
  and are formatted as `namespace + ":" + reference`
- A reference refers to a specific network-id within the kadena ecosystem
- **NOTE**: Chain IDs in the wallet protocol ARE NOT the same as chainweb/pact’s
  version of “chain-id” — they are much more similar to `networkId`

These are valid kadena chain-ids

```
# Kadena mainnet
kadena:mainnet01

# Current kadena testnet
kadena:testnet04

# Kadena devnet
kadena:development
```

## Accounts

- Accounts in wallet connect are used to specify control over signing privileges
- They must conform to
  [CAIP-10](https://github.com/ChainAgnostic/CAIPs/blob/master/CAIPs/caip-10.md)
  and are formatted: `chain_id + ":" + account_address`
- **NOTE**: Wallet-connect’s `account_address` is NOT the same as pact’s coin
  account. Instead, they are analogous to pact’s `signer`
  ([see here](https://api.chainweb.com/openapi/pact.html#tag/model-payload))

Here are some example accounts:

```

kadena:mainnet01:22ddc64851718e9d41d98b0f33d5e328ae5bbbbd97aed9885adac0f2d070ff9c

kadena:testnet04:38298612cc2d5e841a232bd08413aa5304f9ef3251575ee182345abc3807dd89
```

### **Accounts vs Public Keys**

TODO: add rationale on why accounts are returned instead of public keys

## Default Methods

- The supported methods are:

```
kadena_get_accounts_v1
kadena_sign_v1
kadena_quicksign_v1
```

## Events

- At the moment we see no need to standardize any events and believe that most
  usecases can be handled at the kadena-protocol level that sits atop wallet
  connect. This is subject to change in the future as we understand the
  workflows more through extended use of the protocol

## SLIP-0044

While not required in the namespace proposal process, a network's SLIP-0044
value is used throughout the wallet connect demo code. Kadena's coin type is
**626** as documented in
https://github.com/satoshilabs/slips/blob/master/slip-0044.md

# Backwards Compatibility

- As we work on phasing out the tradition signing-api exposed on localhost port
  9467 we suggest dapps allow users to select between a legacy and
  wallet-connect option when connecting their wallet

# WalletConnect specification

## Pairing with WalletConnect

When setting up a session with WalletConnect the session initiator, potentially
a dApp, makes a proposal request which contains the chains, methods and events
the initiator wants to utilize. The wallet's response contains information on
which of the requested items it supports.

A new session is created, this contains the following properties

- [accounts](#accounts-1)
- [methods](#walletconnect-methods)
- events - we don't have events yet

> NB "accounts" is semantically specific to WalletConnect. This does not
> represent an account in Kadena. The information returned is the `publickey` as
> shown in [WalletConnectAccountAddress](#walletconnectaccountaddress)

### Example Pairing Proposal and Response

```json
# Proposal namespace request
{
  "kadena": {
    "chains": ["kadena:mainnet01", "kadena:testnet04", "kadena:development"],
    "methods": ["kadena_sign_v1", "kadena_quicksign_v1"],
    "events": []
  }
}
```

```json
# Session namespace response
{
  "kadena": {
    "accounts": [
      "kadena:mainnet01:38298612cc2d5e841a232bd08413aa5304f9ef3251575ee182345abc3807dd89",
      "kadena:testnet04:38298612cc2d5e841a232bd08413aa5304f9ef3251575ee182345abc3807dd89",
      "kadena:testnet04:22ddc64851718e9d41d98b0f33d5e328ae5bbbbd97aed9885adac0f2d070ff9c"
    ],
    "methods": ["kadena_sign_v1", "kadena_quicksign_v1"],
    "events": []
    }
}
```

### Accounts

The accounts property is an Array of
*[`WalletConnectAccountString`](#walletconnectaccountstring)*s

### WalletConnectAccountString

This is the description of an account provided by the wallet

A **WalletConnectAccountString** is build from
[`WalletConnectChainID`](#walletconnectchainid)`:`[`WalletConnectAccountAddress`](#walletconnectaccountaddress)

#### WalletConnectChainID

This is the description of the chain. It's build from
[`WalletConnectNamespace`](#walletconnectnamespace)`:`[`WalletConnectReference`](#walletconnectreference)

#### WalletConnectNamespace

The namespace for Kadena is `kadena`

#### WalletConnectReference

Is one of:

- `mainnet01`
- `testnet04`
- `development`

#### WalletConnectAccountAddress

This is the Kadena `publickey` that the wallet has access to. In some cases the
account belonging associated with the publickey in a fungible contract e.g.
`coin` can be derived from the publickey, in other cases to get the account to
use with this publickey the [`kadena_get_accounts_v1`](#kadena_get_accounts_v1)
method can be called.

## WalletConnect Methods

The methods available are:

- [`kadena_get_accounts_v1`](#kadena_get_accounts_v1)
- [`kadena_quicksign_v1`](#kadena_quicksign_v1)
- [`kadena_sign_v1`](#kadena_sign_v1)

### kadena_get_accounts_v1

From the [Paring response](#pairing-with-walletconnect) an element from the
`accounts` property can be used to retrieve the available KadenaAccounts

#### Example kadena_get_accounts_v1 Request and Response

```jsonc
// kadena_get_accounts_v1 request
{
  "accounts": [
    "kadena:mainnet01:38298612cc2d5e841a232bd08413aa5304f9ef3251575ee182345abc3807dd89"
  ]
}
```

```jsonc
// kadena_get_accounts_v1 response
{
  "accounts": [
    {
      "account": "kadena:mainnet01:38298612cc2d5e841a232bd08413aa5304f9ef3251575ee182345abc3807dd89",
      "pubkey": "38298612cc2d5e841a232bd08413aa5304f9ef3251575ee182345abc3807dd89",
      "kadenaAccounts": [
        {
          "name": "w:aoriestnaoirsetnaorisetn",
          "contract": "coin",
          "chains": ["0", "1"]
        },
        {
          "name": "k:38298612cc2d5e841a232bd08413aa5304f9ef3251575ee182345abc3807dd89",
          "contract": "coin",
          "chains": [
            "0",
            "1",
            "2",
            "3",
            "4",
            "5",
            "6",
            "7",
            "8",
            "9",
            "10",
            "11",
            "12",
            "13",
            "14",
            "15",
            "16",
            "17",
            "18",
            "19"
          ]
        }
      ]
    }
  ]
}
```

#### Request Body

This method needs to be called with a body with the following properties:

- `accounts` an array of
  [WalletConnectAccountString](#walletconnectaccountstrings)

#### Response Body

The response contains the following properties

- `accounts` - an **Array** of [KadenaSigner](#kadenasigners)

##### KadenaSigner

An object with properties:

- `account` - a reference to the name of the requested
  [WalletConnectAccountString](#walletconnectaccountstring)
- `pubkey` - the corresponding public-key
- `kadenaAccounts` - an **Array** of [KadenaAccount](#kadenaaccount)

##### KadenaAccount

An object with properties

- `name` - the named account as stored in the blockchain for that specific
  contract
- `contract` - the contract that this account is used for
- `chains` - the chains on which this account is listed

> NB KadenaAccounts for several contracts, e.g. `coin` and `my-fungible` are
> seperate entries as the chains on which they are deployed can differ.

### kadena_quicksign_v1

#### Example kadena_quicksign_v1 Request and Response

```json
# Signing request
{
  "commandSigDatas": [CommandSigData]
}
```

The structure of `CommandSigData` is defined in the
[kip-0015 quicksign signing api v1](https://github.com/kadena-io/KIPs/blob/master/kip-0015.md#commandsigdata)

```json
# Succesfull Signing response
{
  "responses": [Response]
}
```

or

```json
# Failed Signing response
{
  "error": QuicksignError
}

```

The structure of `Response` and `QuicksignError` are defined in the
[kip-0015 quicksign signing api v1](https://github.com/kadena-io/KIPs/blob/master/kip-0015.md#quicksign-response)

### kadena_sign_v1

#### Example kadena_sign_v1 Request and Response

```json
# Signing request
{
  signingCmd
}

```

The structure of `signingCmd` is defined in the
[Chainweaver Signing Api](https://github.com/kadena-io/pact-lang-api#chainweaver-signing-api-command)

```json
# Signing response
{
  "signedCmd": {
      cmd: ...,
      hash: ...
      sigs: [
        ...
      ]
    }
}
```

# Rationale for the spec

TODO: document the considerations and incorporate the `NB`s from the spec
